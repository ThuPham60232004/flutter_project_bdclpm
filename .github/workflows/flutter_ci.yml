name: ğŸš€ Flutter CI/CD

on:
  push:
    branches:
      - develop
      - staging
      - master/production

jobs:
  # B1: Test vÃ  phÃ¢n tÃ­ch code
  test:
    name: âœ… Test and Analyze
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ›  Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Verify formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ§ª Run tests
        run: flutter test --coverage

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“¢ Notify Slack - Test Completed
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… Test and analysis completed successfully!"}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # B2: Build Android App
  build-android:
    name: ğŸ“¦ Build Android App
    needs: test
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ›  Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ—ï¸ Build debug APK
        run: flutter build apk --debug

      - name: ğŸ“¤ Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: build/app/outputs/flutter-apk/app-debug.apk

      - name: ğŸ“¢ Notify Slack - Build Completed
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… Build completed successfully!"}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # B3: Firebase Test Lab (CHá»ˆ CHáº Y TRÃŠN staging)
  firebase-test-lab:
    name: ğŸ” Run UI Tests on Firebase Test Lab
    needs: build-android
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: ğŸ›  Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download APK
        uses: actions/download-artifact@v4
        with:
          name: app-debug
          path: app-debug

      - name: ğŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCLOUD_AUTH }}'

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ“¥ Install beta components
        run: |
          gcloud components install beta --quiet
          gcloud components update --quiet

      - name: ğŸ§ª Run tests in Firebase Test Lab
        run: |
          BUCKET_NAME="testflutter"
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          gcloud firebase test android run \
            --type robo \
            --app app-debug/app-debug.apk \
            --device model=Pixel2,version=28,locale=en \
            --timeout 300s \
            --results-bucket=gs://$BUCKET_NAME \
            --results-dir=results-$TIMESTAMP \
            --quiet

      - name: ğŸ“¢ Notify Slack - Firebase Test Completed
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… Firebase Test completed for staging!"}' ${{ secrets.SLACK_WEBHOOK_URL }}

  # B4: Deploy code tá»« develop -> staging náº¿u pass CI/CD
  merge-to-staging:
    name: ğŸ”€ Merge develop â†’ staging
    needs: [test, build-android]
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: ğŸ”€ Create Pull Request to Staging
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUBTOKEN }}
          base: staging
          branch: develop
          title: "ğŸ”€ Merge develop â†’ staging"
          body: "This PR is auto-generated after successful CI/CD execution."

  # B5: Deploy code tá»« staging -> master/production náº¿u pass CI/CD
  merge-to-master:
    name: ğŸ”€ Merge staging â†’ master/production
    needs: firebase-test-lab
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: ğŸ”€ Create Pull Request to Master
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUBTOKEN }}
          base: master/production
          branch: staging
          title: "ğŸ”€ Merge staging â†’ master/production"
          body: "This PR is auto-generated after successful CI/CD execution."

  # B6: Deploy to Play Store
  deploy-play-store:
    name: ğŸš€ Deploy to Play Store
    needs: merge-to-master
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/master/production' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”§ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸš€ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          channel: 'stable'
          cache: true

      - name: ğŸ”‘ Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks

      - name: ğŸ—ï¸ Build Release AAB
        run: |
          flutter pub get
          flutter build appbundle --release

      # - name: ğŸ“¤ Deploy to Play Store
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
      #     packageName: com.example.flutter_getx_boilerplate
      #     releaseFiles: build/app/outputs/bundle/release/app-release.aab
      #     track: internal
      #     status: completed
      #     changesNotSentForReview: false
